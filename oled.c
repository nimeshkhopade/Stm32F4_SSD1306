#include <stm32f4xx.h>
#include <string.h>

#define FONT_SIZE 5
const int Font[][FONT_SIZE]=
{
        0x00, 0x00, 0x00, 0x00, 0x00,   // space
        0x00, 0x00, 0x2f, 0x00, 0x00,   // !
        0x00, 0x07, 0x00, 0x07, 0x00,   // "
        0x14, 0x7f, 0x14, 0x7f, 0x14,   // #
        0x24, 0x2a, 0x7f, 0x2a, 0x12,   // $
        0x23, 0x13, 0x08, 0x64, 0x62,   // %
        0x36, 0x49, 0x55, 0x22, 0x50,   // &
        0x00, 0x05, 0x03, 0x00, 0x00,   // '
        0x00, 0x1c, 0x22, 0x41, 0x00,   // (
        0x00, 0x41, 0x22, 0x1c, 0x00,   // )
        0x14, 0x08, 0x3E, 0x08, 0x14,   // *
        0x08, 0x08, 0x3E, 0x08, 0x08,   // +
        0x00, 0x00, 0xA0, 0x60, 0x00,   // ,
        0x08, 0x08, 0x08, 0x08, 0x08,   // -
        0x00, 0x60, 0x60, 0x00, 0x00,   // .
        0x20, 0x10, 0x08, 0x04, 0x02,   // /

        0x3E, 0x51, 0x49, 0x45, 0x3E,   // 0
        0x00, 0x42, 0x7F, 0x40, 0x00,   // 1
        0x42, 0x61, 0x51, 0x49, 0x46,   // 2
        0x21, 0x41, 0x45, 0x4B, 0x31,   // 3
        0x18, 0x14, 0x12, 0x7F, 0x10,   // 4
        0x27, 0x45, 0x45, 0x45, 0x39,   // 5
        0x3C, 0x4A, 0x49, 0x49, 0x30,   // 6
        0x01, 0x71, 0x09, 0x05, 0x03,   // 7
        0x36, 0x49, 0x49, 0x49, 0x36,   // 8
        0x06, 0x49, 0x49, 0x29, 0x1E,   // 9

        0x00, 0x36, 0x36, 0x00, 0x00,   // :
        0x00, 0x56, 0x36, 0x00, 0x00,   // ;
        0x08, 0x14, 0x22, 0x41, 0x00,   // <
        0x14, 0x14, 0x14, 0x14, 0x14,   // =
        0x00, 0x41, 0x22, 0x14, 0x08,   // >
        0x02, 0x01, 0x51, 0x09, 0x06,   // ?
        0x32, 0x49, 0x59, 0x51, 0x3E,   // @

        0x7C, 0x12, 0x11, 0x12, 0x7C,   // A
        0x7F, 0x49, 0x49, 0x49, 0x36,   // B
        0x3E, 0x41, 0x41, 0x41, 0x22,   // C
        0x7F, 0x41, 0x41, 0x22, 0x1C,   // D
        0x7F, 0x49, 0x49, 0x49, 0x41,   // E
        0x7F, 0x09, 0x09, 0x09, 0x01,   // F
        0x3E, 0x41, 0x49, 0x49, 0x7A,   // G
        0x7F, 0x08, 0x08, 0x08, 0x7F,   // H
        0x00, 0x41, 0x7F, 0x41, 0x00,   // I
        0x20, 0x40, 0x41, 0x3F, 0x01,   // J
        0x7F, 0x08, 0x14, 0x22, 0x41,   // K
        0x7F, 0x40, 0x40, 0x40, 0x40,   // L
        0x7F, 0x02, 0x0C, 0x02, 0x7F,   // M
        0x7F, 0x04, 0x08, 0x10, 0x7F,   // N
        0x3E, 0x41, 0x41, 0x41, 0x3E,   // O
        0x7F, 0x09, 0x09, 0x09, 0x06,   // P
        0x3E, 0x41, 0x51, 0x21, 0x5E,   // Q
        0x7F, 0x09, 0x19, 0x29, 0x46,   // R
        0x46, 0x49, 0x49, 0x49, 0x31,   // S
        0x01, 0x01, 0x7F, 0x01, 0x01,   // T
        0x3F, 0x40, 0x40, 0x40, 0x3F,   // U
        0x1F, 0x20, 0x40, 0x20, 0x1F,   // V
        0x3F, 0x40, 0x38, 0x40, 0x3F,   // W
        0x63, 0x14, 0x08, 0x14, 0x63,   // X
        0x07, 0x08, 0x70, 0x08, 0x07,   // Y
        0x61, 0x51, 0x49, 0x45, 0x43,   // Z

        0x00, 0x7F, 0x41, 0x41, 0x00,   // [
        0x55, 0xAA, 0x55, 0xAA, 0x55,   // Backslash (Checker pattern)
        0x00, 0x41, 0x41, 0x7F, 0x00,   // ]
        0x04, 0x02, 0x01, 0x02, 0x04,   // ^
        0x40, 0x40, 0x40, 0x40, 0x40,   // _
        0x00, 0x03, 0x05, 0x00, 0x00,   // `

        0x20, 0x54, 0x54, 0x54, 0x78,   // a
        0x7F, 0x48, 0x44, 0x44, 0x38,   // b
        0x38, 0x44, 0x44, 0x44, 0x20,   // c
        0x38, 0x44, 0x44, 0x48, 0x7F,   // d
        0x38, 0x54, 0x54, 0x54, 0x18,   // e
        0x08, 0x7E, 0x09, 0x01, 0x02,   // f
        0x18, 0xA4, 0xA4, 0xA4, 0x7C,   // g
        0x7F, 0x08, 0x04, 0x04, 0x78,   // h
        0x00, 0x44, 0x7D, 0x40, 0x00,   // i
        0x40, 0x80, 0x84, 0x7D, 0x00,   // j
        0x7F, 0x10, 0x28, 0x44, 0x00,   // k
        0x00, 0x41, 0x7F, 0x40, 0x00,   // l
        0x7C, 0x04, 0x18, 0x04, 0x78,   // m
        0x7C, 0x08, 0x04, 0x04, 0x78,   // n
        0x38, 0x44, 0x44, 0x44, 0x38,   // o
        0xFC, 0x24, 0x24, 0x24, 0x18,   // p
        0x18, 0x24, 0x24, 0x18, 0xFC,   // q
        0x7C, 0x08, 0x04, 0x04, 0x08,   // r
        0x48, 0x54, 0x54, 0x54, 0x20,   // s
        0x04, 0x3F, 0x44, 0x40, 0x20,   // t
        0x3C, 0x40, 0x40, 0x20, 0x7C,   // u
        0x1C, 0x20, 0x40, 0x20, 0x1C,   // v
        0x3C, 0x40, 0x30, 0x40, 0x3C,   // w
        0x44, 0x28, 0x10, 0x28, 0x44,   // x
        0x1C, 0xA0, 0xA0, 0xA0, 0x7C,   // y
        0x44, 0x64, 0x54, 0x4C, 0x44,   // z

        0x00, 0x10, 0x7C, 0x82, 0x00,   // {
        0x00, 0x00, 0xFF, 0x00, 0x00,   // |
        0x00, 0x82, 0x7C, 0x10, 0x00,   // }
        0x00, 0x06, 0x09, 0x09, 0x06    // ~ (Degrees)
};

void board_init() {
		
	/* Flash settings (see RM0090 rev9, p80) */

	FLASH->ACR =
            FLASH_ACR_LATENCY_5WS               // 6 CPU cycle wait 
          | FLASH_ACR_PRFTEN                    // enable prefetch 
          | FLASH_ACR_ICEN                      // instruction cache enable *
          | FLASH_ACR_DCEN;                     // data cache enable 
	
	
	/********* CLOCK GENERATION **********/
	
	RCC->CFGR = RCC_CFGR_PPRE2_DIV2           // APB2 prescaler 
								| RCC_CFGR_PPRE1_DIV4;          // APB1 prescaler 
				
	
	RCC->CR = RCC_CR_HSEON;         /* Enable external oscillator */

	/* Wait for locked external oscillator */
	while((RCC->CR & RCC_CR_HSERDY) != RCC_CR_HSERDY);
	
	/* PLL config */
	RCC->PLLCFGR =
          RCC_PLLCFGR_PLLSRC_HSE                /* PLL source */
        | (4 << 0)                              /* PLL input division */
        | (168 << 6)                            /* PLL multiplication */
        | (0 << 16)                             /* PLL sys clock division */
        | (7 << 24);                            /* PLL usb clock division =48MHz */
	
	RCC->CR |= RCC_CR_PLLON;		/* Enable PLL */

	while((RCC->CR & RCC_CR_PLLRDY) != RCC_CR_PLLRDY);	/* Wait for locked PLL */
	
	RCC->CFGR &= ~RCC_CFGR_SW; 		/* select system clock */			/* clear */
	
	RCC->CFGR |= RCC_CFGR_SW_PLL | RCC_CFGR_PPRE1_DIV4 | RCC_CFGR_PPRE2_DIV2;   /* SYSCLK is PLL */
	
	while((RCC->CFGR & RCC_CFGR_SW_PLL) != RCC_CFGR_SW_PLL);		/* Wait for SYSCLK to be PLL */
	/************ /CLOCK GENERATION ************/

	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN; //Enable GPIO B Clock
	
	RCC->APB1ENR = 1 << 21; //I2C1 ON
	
	GPIOB->AFR[0] |= 4 << 24; //Configure PB6 to alternate function -> I2C(SCL)
	
	GPIOB->AFR[1] |= 4 << 4; //Configure PB9 to alternate function -> I2C(SDA)
	
	GPIOB->MODER |= 2 << 12 | 2 << 18; //PB6 | PB9
	
	GPIOB->OTYPER = 1 << 6 | 1 << 9; // Open Drain
	
	GPIOB->OSPEEDR |= 1 << 12 | 1 << 18; // Medium Speed
	
	GPIOB->PUPDR |= 1 << 12 | 1 << 18; // PULLUP VERY IMPORTANT
	
	/*************** I2C Config *******************/
	
	I2C1->CR2 |= 16 << 0; //16MHz peri clk
	
	I2C1->CCR |= 0x0050; // for 100KHz SM mode
	
	I2C1->TRISE = 0x0011; //17 (1000ns/62.5ns = 16 + 1)
	
	I2C1->CR1 |= 1 << 0; // Enable peripheral
	
	/************ //I2C config ******************/
}


void delay(){
	int j = 0, i = 0;
	for(i = 0;i < 1; i++)
	{
		for(j = 0; j < 1; j++){}
	}
}

void i2c_start() {
	I2C1->CR1 |= 1 << 8; //Start I2C
	while(!(I2C1->SR1&0x0001));
}

void i2c_stop() {
	I2C1->CR1 |= 1 << 9; //Stop I2C
	while(I2C1->SR2&0x0002);
}

void i2c_write(int c) {
	I2C1->DR = c; //send data
	delay();
	while(!(I2C1->SR1 & (1 << 7)));
}

void i2c_addr(unsigned int i) {
	char res;
	I2C1->DR = i | 0; //send addr
	delay();
	while(!(I2C1->SR1&0x0002));
	res = I2C1->SR2;
}

void bat_work() {
		int i = 0;
	i2c_start();
	i2c_addr(0x3C<<1);
	i2c_write(0x40);
	i2c_write(0xFF);
	i2c_write(0xFF);
	i2c_write(0xFF);
	i2c_write(0xFF);
	i2c_write(0xFF);
	i2c_write(0xFF);
	i2c_write(0x81);
	i2c_write(0x81);
	i2c_write(0x81);
	i2c_write(0x81);
	i2c_write(0x81);
	i2c_write(0xE7);
	i2c_write(0x24);
	//i2c_write(0x24);
	//i2c_write(0x24);
	i2c_write(0x3C);
	for(i = 0; i<5; i++) {
		i2c_write(Font[0][i]);
	}
	/*
	for(i = 0; i<5; i++) {
		i2c_write(Font[10][i]);
	}
	*/
	i2c_write(0xC0);
	i2c_write(0x00);
	i2c_write(0xF0);
	i2c_write(0x00);
	i2c_write(0xFC);
	i2c_write(0x00);
	i2c_write(0xFF);
	i2c_stop();
	
}

void text(char* t, int len) {
	int i = 0, j = 0;
	i2c_start();
	i2c_addr(0x78);
	i2c_write(0x40);
	for(i = 0; i<len; i++) {
		for(j = 0; j<5; j++) {
			i2c_write(Font[t[i]-32][j]);
		}
		i2c_write(0x00);
	}
	i2c_stop();
}


void oled_cmd(int cmd) {
	i2c_start();
	i2c_addr(0x3C<<1);
	i2c_write(0x00);
	i2c_write(cmd);
	i2c_stop();
}

void oled_clear() {
	int i = 0;
	
	oled_cmd(0x21);
	oled_cmd(0x00);
	oled_cmd(127);
	oled_cmd(0x22);
	oled_cmd(0x00);
	oled_cmd(0x07);
	
	i2c_start();
	i2c_addr(0x3C << 1);
	i2c_write(0x40);
	
	for(i = 0; i<1024; i++) {
		i2c_write(0);
	}
	
	oled_cmd(0x21);
	oled_cmd(0x00);
	oled_cmd(127);
	oled_cmd(0x22);
	oled_cmd(0x00);
	oled_cmd(0x07);
}

void pos(int x , int y) {
	oled_cmd(0x21);
	oled_cmd(x);
	oled_cmd(127);
	oled_cmd(0x22);
	oled_cmd(y);
	oled_cmd(0x07);	
}

void oled_init() {
	oled_cmd(0xAE);
	oled_cmd(0xD5);
	oled_cmd(0x80);
	oled_cmd(0xA8);
	oled_cmd(0x3F);
	oled_cmd(0xD3);
	oled_cmd(0x00);
	oled_cmd(0x40 | 0x00);
	oled_cmd(0x8D);
	oled_cmd(0x14);
	oled_cmd(0x20);
	oled_cmd(0x00);
	oled_cmd(0xA0 | 0x1);
	oled_cmd(0xC8);
	oled_cmd(0xDA);
	oled_cmd(0x12);
	oled_cmd(0x81);
	oled_cmd(0xCF);
	oled_cmd(0xD9);
	oled_cmd(0xF1);
	oled_cmd(0xDB);
	oled_cmd(0x80);
	oled_cmd(0xA4);
	oled_cmd(0xA6);
	oled_cmd(0xAF);
	oled_clear();
}

int main(void)
{
	int len = 0, i = 0;
	char s[] = "Hello World :)"; //Enter String To be Printed.
	
	const unsigned char sun [] = {
			0x08, 0x00, 0x99, 0x3C, 0x3C, 0x99, 0x00, 0x08, 
		};
	
	board_init();
	oled_init();
	bat_work();
	
	pos(100, 0);
		
	i2c_start();
	i2c_addr(0x78);
	i2c_write(0x40);
	for(i = 0; i<5; i++) {
		i2c_write(Font[0][i]);
	}
	for(i = 0; i<8; i++) {
		i2c_write(sun[i]);
	}
	i2c_stop();
	pos(0, 3);
	
	len = strlen(s);
	text(s,len);
	
	while(1){
	
	} 
}
